<?php

/**
 * Implements hook_menu().
 */
function islandora_usage_stats_callbacks_menu() {
  $menu['islandora_usage_stats_callbacks/object_stats/%'] = array (
    'page callback' => 'get_object_stats',
    'page arguments' => array(2),
    'access callback' => TRUE,
  );
  return $menu;
}


/**
 * Callback functions
 */
function get_object_stats($pid) {
  $report = array();
  $ids = get_object_ids($pid);
  $report['pid'] = $ids['pid'];
  $report['cmodel'] = $ids['cmodel'];
  $report['views'] = get_object_views($ids);
  $report['downloads'] = get_object_downloads($ids);
  echo json_encode($report);
  drupal_exit();
}


/**
 * DB parsing helper functions
 */
function get_object_ids($pid) {
  $ids = array();
  $ids['pid'] = $pid;
  $ids['cmodel'] = islandora_object_load($pid)->models[0];
  $cmodel_dsids = array('ir:citationCModel' => 'PDF', 
                        'ir:thesisCModel' => 'PDF', 
                        'islandora:sp_pdf' => 'OBJ');
  if ($ids['cmodel'] == '') {
    echo json_encode(array('error' => "invalid PID '${ids['pid']}'")); 
    drupal_exit();
  }
  elseif (!in_array($ids['cmodel'], array_keys($cmodel_dsids))) {
    echo json_encode(array('error' => "unsupported content model '${ids['cmodel']}'")); 
    drupal_exit();
  }
  $ids['dsid'] = $cmodel_dsids[$ids['cmodel']];
  $ids['usid'] = db_query("SELECT id FROM islandora_usage_stats_objects WHERE pid='${pid}'")->fetchAssoc()['id'];
  if ($ids['usid'] == '') {
    echo json_encode(array('pid' => $ids['pid'], 'cmodel' => $ids['cmodel'], 'views' => array(), 'downloads' => array()));
    drupal_exit();
  } 
  return $ids;
}

function get_object_views($ids) {
  $query = "SELECT time, ip FROM islandora_usage_stats_object_access_log WHERE pid_id=${ids['usid']}";
  $result = db_query($query)->fetchAll();;
  return $result;
}

function get_object_downloads($ids) {
  $query = "SELECT id FROM islandora_usage_stats_datastreams WHERE pid_id=${ids['usid']} AND dsid='${ids['dsid']}'";
  $usdsid = db_query($query)->fetchAssoc()['id'];
  if ($usdsid == '') {
    return array();
  }
  else {
    $query = "SELECT time, ip FROM islandora_usage_stats_object_ds_access_log where ds_id=${usdsid}"; 
    $result = db_query($query)->fetchAll();;
    return $result;
  }
}
